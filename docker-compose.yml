services:
  # ---------------------------------------
  # Base de Datos (SQL Server / Azure Edge)
  # ---------------------------------------
  db:
    image: mcr.microsoft.com/azure-sql-edge:latest
    container_name: EcommerceCore-db
    user: "root"
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${SA_PASSWORD}
    ports:
      - "1433:1433"
    volumes:
      - sql_data:/var/opt/mssql/data
    networks:
      - app-network

  # ---------------------------------------
  # Backend (.NET API)
  # ---------------------------------------
  api:
    build:
      context: ./EcommerceCore
      dockerfile: Dockerfile
    container_name: EcommerceCore-api
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      # Cadena de conexión apuntando al servicio 'db' en lugar de localhost
      - ConnectionStrings__DefaultConnection=Server=db,1433;Database=EcommerceCore_db;User Id=sa;Password=${SA_PASSWORD};TrustServerCertificate=True;
      # Configuración JWT (debe coincidir con secrets o ser inyectada)
      - Jwt__Key=${JWT_KEY}
      - Jwt__Issuer=http://localhost:5272
      # Configuración AppSettings
      - AppSettings__FrontendBaseUrl=http://localhost:5173
      # Configuración Google
      - Authentication__Google__ClientId=${GOOGLE_CLIENT_ID:-change_me}
      - Authentication__Google__ClientSecret=${GOOGLE_CLIENT_SECRET:-change_me}
      # Mapeo de variables SMTP del .env a la configuración de .NET
      - SmtpSettings__Host=${SMTP_HOST}
      - SmtpSettings__Port=${SMTP_PORT}
      - SmtpSettings__Username=${SMTP_USERNAME}
      - SmtpSettings__Password=${SMTP_PASSWORD}
      - SmtpSettings__FromEmail=${SMTP_FROM_EMAIL}
      - SmtpSettings__FromName=${SMTP_FROM_NAME}
      # Configuración Stripe
      - Stripe__SecretKey=${STRIPE_SECRET_KEY}
    ports:
      - "5272:8080" # Mapeamos el puerto interno 8080 al 5272 de tu máquina
    volumes:
      # Persistencia para avatares subidos
      - uploads_data:/app/wwwroot/uploads
    depends_on:
      - db
    networks:
      - app-network

  # ---------------------------------------
  # Frontend (Vue + Nginx)
  # ---------------------------------------
  web:
    build:
      context: ./client
      dockerfile: Dockerfile
      args:
        # Estas variables se 'cocinan' en el HTML/JS al momento del build
        - VITE_API_BASE_URL=http://localhost:5272/api
        - VITE_UPLOADS_BASE_URL=http://localhost:5272
        - VITE_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-change_me}
        - VITE_STRIPE_PUBLIC_KEY=${STRIPE_PUBLIC_KEY}
    container_name: EcommerceCore-web
    ports:
      - "5173:80"
    depends_on:
      - api
    networks:
      - app-network

volumes:
  sql_data:
  uploads_data:

networks:
  app-network:
    driver: bridge